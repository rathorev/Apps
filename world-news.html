<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>World News — Brief & Fresh</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0b1020; --card:#121933; --text:#e7ecff; --muted:#9fb0ff; --accent:#60a5fa; --chip:#1e293b; --ok:#22c55e; --warn:#f59e0b;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --card:#ffffff; --text:#0b1020; --muted:#475569; --accent:#2563eb; --chip:#eef2ff; --ok:#16a34a; --warn:#d97706;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";}
    .app{max-width:900px;margin:0 auto;padding-bottom:80px;}
    .topbar{
      position:sticky;top:0;z-index:10;backdrop-filter:saturate(180%) blur(8px);
      background:linear-gradient(180deg, rgba(11,16,32,.9), rgba(11,16,32,.6));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    [data-theme="light"] .topbar{background:linear-gradient(180deg, rgba(246,247,251,.95), rgba(246,247,251,.75));}
    .topbar-inner{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem .9rem;}
    .brand{font-weight:800;letter-spacing:.2px}
    .muted{color:var(--muted);font-weight:500}
    .controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    select,input,button{
      border:1px solid rgba(255,255,255,.12);outline:0;background:var(--card);color:var(--text);
      padding:.55rem .6rem;border-radius:.7rem;font-size:.95rem;
    }
    [data-theme="light"] select,[data-theme="light"] input,[data-theme="light"] button{
      border:1px solid rgba(0,0,0,.08);
    }
    input{min-width:160px;width:38vw;max-width:300px}
    button{cursor:pointer}
    .refresh{display:flex;align-items:center;gap:.4rem}
    .pill{background:var(--chip);color:var(--muted);padding:.2rem .5rem;border-radius:999px;font-size:.75rem;border:1px solid rgba(255,255,255,.06)}
    .row{display:grid;grid-template-columns:1fr;gap:.8rem;padding:.75rem}
    @media(min-width:700px){.row{grid-template-columns:1fr 1fr}}
    .card{
      background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:1rem;padding:1rem;
      display:flex;flex-direction:column;gap:.55rem;box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    .card h3{margin:0;font-size:1.02rem;line-height:1.3}
    .meta{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .meta .src{font-weight:600}
    .meta .time{color:var(--muted)}
    .footerbar{
      position:fixed;left:0;right:0;bottom:0;display:flex;gap:.6rem;justify-content:center;align-items:center;
      padding:.6rem;background:linear-gradient(0deg, rgba(0,0,0,.3), rgba(0,0,0,0));
      pointer-events:none;
    }
    .footerbar .fab{
      pointer-events:auto;
      border:none;background:var(--accent);color:white;border-radius:999px;padding:.85rem 1rem;font-weight:700;
      box-shadow:0 10px 24px rgba(37,99,235,.35);
    }
    a{color:inherit;text-decoration:none}
    .card a:hover{text-decoration:underline}
    .empty{padding:2rem;text-align:center;color:var(--muted)}
    .tags{display:flex;gap:.4rem;flex-wrap:wrap}
    .tag{background:var(--chip);padding:.15rem .5rem;border-radius:999px;font-size:.75rem}
    .bar{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin:.25rem .75rem .6rem}
    .toggle{
      appearance:none;width:44px;height:28px;background:var(--chip);border-radius:999px;position:relative;outline:none;border:1px solid rgba(255,255,255,.08);
    }
    .toggle:checked{background:var(--accent)}
    .toggle:before{
      content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:white;transition:left .18s ease;
    }
    .toggle:checked:before{left:19px}
    .status{display:flex;gap:.4rem;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%}
    .ok{background:var(--ok)} .warn{background:var(--warn)}
  </style>
</head>
<body>
  <div class="app" id="app" data-theme="dark">
    <header class="topbar">
      <div class="topbar-inner">
        <div>
          <div class="brand">World News</div>
          <div class="muted" id="last-updated">—</div>
        </div>
        <div class="controls">
          <select id="sourceFilter" title="Filter by source">
            <option value="all">All sources</option>
          </select>
          <input id="q" type="search" placeholder="Search headlines…" />
          <button class="refresh" id="refreshBtn" title="Refresh now">⟳ Refresh</button>
          <label class="status pill">
            <span class="dot ok" id="liveDot"></span><span id="liveText">Live</span>
          </label>
          <label class="pill" title="Toggle light/dark">
            <input type="checkbox" id="themeToggle" class="toggle" />
          </label>
        </div>
      </div>
      <div class="bar">
        <span class="pill">Tap ⟳ anytime</span>
        <span class="pill">Pull-down to refresh on mobile</span>
        <span class="pill" id="autoNote">Auto refresh: 10 min</span>
      </div>
    </header>

    <main class="row" id="grid"></main>
    <div class="empty" id="empty" hidden>Nothing to show. Try clearing the search.</div>

    <div class="footerbar">
      <button class="fab" id="fabRefresh">⟳ Refresh</button>
    </div>
  </div>

  <script>
  // --- Configuration: add/remove feeds freely ---
  const FEEDS = [
    { name: "BBC World", url: "https://feeds.bbci.co.uk/news/world/rss.xml" },
    { name: "Reuters World", url: "https://feeds.reuters.com/Reuters/worldNews" },
    { name: "AP Top", url: "https://feeds.apnews.com/apf-topnews" },
    { name: "Al Jazeera", url: "https://www.aljazeera.com/xml/rss/all.xml" },
    { name: "DW", url: "https://www.dw.com/atom" },
    { name: "The Guardian World", url: "https://www.theguardian.com/world/rss" }
  ];

  // CORS-friendly proxies (we’ll try in order)
  const PROXIES = [
    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    u => `https://r.jina.ai/http://r.jina.ai/http://0.0.0.0/../${encodeURIComponent(u)}`, // fallback trick (rarely used)
    u => `https://cors.isomorphic-git.org/${u}`
  ];

  const state = {
    items: [],
    filter: "all",
    query: "",
    autoMinutes: 10,
    lastUpdated: null
  };

  // Populate filter select
  const filterEl = document.getElementById("sourceFilter");
  FEEDS.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f.name;
    opt.textContent = f.name;
    filterEl.appendChild(opt);
  });

  // Theme toggle
  const themeToggle = document.getElementById("themeToggle");
  const root = document.getElementById("app");
  const savedTheme = localStorage.getItem("wn-theme");
  if (savedTheme) root.setAttribute("data-theme", savedTheme);
  themeToggle.checked = root.getAttribute("data-theme") === "light";
  themeToggle.addEventListener("change", () => {
    const t = themeToggle.checked ? "light" : "dark";
    root.setAttribute("data-theme", t);
    localStorage.setItem("wn-theme", t);
  });

  // Time helpers
  const toDate = s => {
    const d = new Date(s || "");
    return isNaN(d) ? new Date() : d;
  };
  const timeAgo = (d) => {
    const diff = (Date.now() - d.getTime())/1000;
    if (diff<60) return `${Math.floor(diff)}s ago`;
    if (diff<3600) return `${Math.floor(diff/60)}m ago`;
    if (diff<86400) return `${Math.floor(diff/3600)}h ago`;
    return `${Math.floor(diff/86400)}d ago`;
  };
  const fmtUpdate = d => d ? `Updated ${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : "—";

  // Parse RSS/Atom into common shape
  function parseFeed(xmlText, sourceName){
    const dom = new DOMParser().parseFromString(xmlText, "text/xml");

    // Check for parsererror
    if (dom.querySelector("parsererror")) return [];

    const out = [];
    // RSS
    dom.querySelectorAll("item").forEach(item=>{
      const title = item.querySelector("title")?.textContent?.trim() || "(untitled)";
      const link = item.querySelector("link")?.textContent?.trim() || item.querySelector("guid")?.textContent?.trim() || "#";
      const pubRaw = item.querySelector("pubDate")?.textContent || item.querySelector("dc\\:date, date")?.textContent;
      const pubDate = toDate(pubRaw);
      const desc = item.querySelector("description")?.textContent || "";
      out.push({title, link, pubDate, source: sourceName, desc});
    });

    // Atom
    dom.querySelectorAll("entry").forEach(entry=>{
      const title = entry.querySelector("title")?.textContent?.trim() || "(untitled)";
      const link = entry.querySelector("link[href]")?.getAttribute("href") || "#";
      const pubRaw = entry.querySelector("updated")?.textContent || entry.querySelector("published")?.textContent;
      const pubDate = toDate(pubRaw);
      const desc = entry.querySelector("summary")?.textContent || entry.querySelector("content")?.textContent || "";
      out.push({title, link, pubDate, source: sourceName, desc});
    });

    return out;
  }

  async function fetchWithProxies(url){
    let lastErr;
    for (const make of PROXIES){
      try{
        const res = await fetch(make(url), { cache: "no-store" });
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        const text = await res.text();
        if (text && text.length > 30) return text;
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("Failed to fetch " + url);
  }

  async function loadAll(){
    setLive(true);
    const cards = [];
    await Promise.allSettled(
      FEEDS.map(async f=>{
        try{
          const xml = await fetchWithProxies(f.url);
          const items = parseFeed(xml, f.name);
          cards.push(...items);
        }catch(e){
          console.warn("Feed failed:", f.name, e);
          // Push a synthetic warning card so the user sees which one failed
          cards.push({
            title: `⚠︎ Could not load ${f.name}`,
            link: "#",
            pubDate: new Date(),
            source: f.name,
            desc: (e && e.message) ? e.message : "Unknown error"
          });
        }
      })
    );
    state.items = cards
      .filter(it => it.title && it.link)
      .sort((a,b)=> b.pubDate - a.pubDate)
      .slice(0, 200); // keep it snappy
    state.lastUpdated = new Date();
    render();
    setLive(false);
    localStorage.setItem("wn-cache", JSON.stringify({
      t: state.lastUpdated.getTime(),
      items: state.items.map(i => ({...i, pubDate: i.pubDate.toISOString()}))
    }));
  }

  function setLive(on){
    const dot = document.getElementById("liveDot");
    const txt = document.getElementById("liveText");
    if (on){ dot.classList.remove("warn"); dot.classList.add("ok"); txt.textContent = "Loading…"; }
    else { dot.classList.remove("ok"); dot.classList.add("warn"); txt.textContent = "Idle"; setTimeout(()=>{dot.classList.remove("warn"); dot.classList.add("ok"); txt.textContent="Live";}, 1200); }
  }

  function render(){
    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");
    const q = state.query.trim().toLowerCase();
    const filtered = state.items.filter(it => {
      const okSrc = state.filter==="all" || it.source===state.filter;
      const okQ = !q || it.title.toLowerCase().includes(q) || it.desc.toLowerCase().includes(q) || it.source.toLowerCase().includes(q);
      return okSrc && okQ;
    });

    grid.innerHTML = "";
    document.getElementById("last-updated").textContent = fmtUpdate(state.lastUpdated);

    if (!filtered.length){
      empty.hidden = false;
      return;
    }
    empty.hidden = true;

    const frag = document.createDocumentFragment();
    filtered.forEach(it=>{
      const card = document.createElement("article");
      card.className = "card";
      const h3 = document.createElement("h3");
      const a = document.createElement("a");
      a.href = it.link; a.target = "_blank"; a.rel="noopener noreferrer";
      a.textContent = it.title;
      h3.appendChild(a);

      const meta = document.createElement("div");
      meta.className = "meta";
      const src = document.createElement("span"); src.className="src tag"; src.textContent = it.source;
      const t = document.createElement("span"); t.className="time"; t.textContent = timeAgo(new Date(it.pubDate));
      meta.append(src,t);

      const desc = document.createElement("p");
      const snip = (it.desc || "").replace(/<[^>]+>/g,"").trim();
      desc.textContent = snip.length>220 ? snip.slice(0,217)+"…" : snip;

      card.append(h3, meta, desc);
      frag.appendChild(card);
    });
    grid.appendChild(frag);
  }

  // UI events
  filterEl.addEventListener("change", e => { state.filter = e.target.value; render(); });
  document.getElementById("q").addEventListener("input", e => { state.query = e.target.value; render(); });
  document.getElementById("refreshBtn").addEventListener("click", loadAll);
  document.getElementById("fabRefresh").addEventListener("click", loadAll);

  // Pull-to-refresh (simple)
  (function enablePullToRefresh(){
    let startY = 0, pulling = false;
    window.addEventListener("touchstart", e=>{
      if (document.scrollingElement.scrollTop === 0){
        startY = e.touches[0].clientY; pulling = true;
      }
    }, {passive:true});
    window.addEventListener("touchmove", e=>{
      if (!pulling) return;
      const dy = e.touches[0].clientY - startY;
      if (dy > 90){ pulling = false; loadAll(); }
    }, {passive:true});
    window.addEventListener("touchend", ()=> pulling=false, {passive:true});
  })();

  // Auto refresh
  const autoNote = document.getElementById("autoNote");
  autoNote.textContent = `Auto refresh: ${state.autoMinutes} min`;
  setInterval(loadAll, state.autoMinutes * 60 * 1000);

  // Load from cache quickly, then refresh
  (function bootstrap(){
    try{
      const raw = localStorage.getItem("wn-cache");
      if (raw){
        const {t, items} = JSON.parse(raw);
        state.items = (items||[]).map(i=> ({...i, pubDate: new Date(i.pubDate)}));
        state.lastUpdated = t ? new Date(t) : null;
        render();
      }
    }catch{}
    loadAll();
  })();

  // Optional: Service Worker for faster reloads (no offline complexity)
  if ("serviceWorker" in navigator){
    const sw = `
      self.addEventListener('install',e=>self.skipWaiting());
      self.addEventListener('activate',e=>self.clients.claim());
      self.addEventListener('fetch',()=>{}); // pass-through
    `;
    const blob = new Blob([sw],{type:"text/javascript"});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url).catch(()=>{});
  }
  </script>
</body>
</html>
